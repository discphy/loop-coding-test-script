# 스케줄러 설정 가이드

## 일일 집계 스케줄러 설정

매일 자정에 전날 챌린지 참여 현황을 자동으로 집계하는 스케줄러입니다.

### 트리거 설정 방법

1. **Apps Script 편집기 열기**
   - Google Sheets에서 `확장 프로그램 > Apps Script` 선택

2. **트리거 추가**
   - 좌측 메뉴에서 시계 아이콘(⏰) "트리거" 클릭
   - 우측 하단 "트리거 추가" 버튼 클릭

3. **트리거 설정**
   - **실행할 함수**: `runDailyAggregation`
   - **이벤트 소스**: `시간 기반`
   - **시간 기반 트리거 유형**: `일 타이머`
   - **시간 선택**: `자정~오전 1시`

4. **저장**
   - "저장" 버튼 클릭
   - 필요시 Google 계정 권한 승인

### 집계 내용

- **날짜**: 집계 대상 날짜 (전날)
- **챌린저 수**: 해당 날짜 기준 등록된 챌린저 수 (등록일이 집계 날짜 이전인 챌린저만 포함)
- **제출 성공**: 해당 날짜에 제출한 챌린저 수
- **미제출**: 제출하지 않은 챌린저 수
- **성공률(%)**: (제출 성공 / 챌린저 수) × 100
- **제출자/미제출자 멘션**: Slack ID 기반 @멘션 형식으로 표시

### 테스트 방법

특정 날짜의 집계를 수동으로 실행하려면:

```javascript
// Apps Script 편집기에서 실행
testDailyAggregation("2025-10-23");
```

오늘 날짜로 테스트:
```javascript
testDailyAggregation();
```

### 스크립트 속성 설정

관리자 알림을 받으려면 다음 속성을 설정해야 합니다:

1. **Apps Script 편집기**에서 프로젝트 설정 (⚙️) 클릭
2. **스크립트 속성** 탭 선택
3. 다음 속성 추가:
   - 속성: `SLACK_MANAGE_WEBHOOK_URL`
   - 값: Slack 관리자 채널 Incoming Webhook URL

### 경고 및 퇴출 시스템

- 미제출 시 경고 1회 누적
- **경고 2회 초과 시** 관리자 Slack 채널로 알림 전송
- 알림 형식: `⚠️ *퇴출 필요* | @멘션님 경고 {경고횟수}회로 퇴출이 필요합니다.`
- Slack ID가 있는 챌린저는 @멘션으로 표시되며, 없는 경우 사용자명으로 표시됩니다
- 자동 퇴출되지 않으며, 관리자가 수동으로 조치해야 합니다

### Slack 알림

스케줄러 실행 후 다음과 같은 알림이 전송됩니다:

#### 일반 채널 알림 (`SLACK_WEBHOOK_URL`)

**간단 요약:**
```
오늘 하루도 고생하셨습니다. 8명 챌린지 완료 ✅, 2명 챌린지 실패 ❌
```

**상세 집계 결과:**
```
📊 2025-11-12 집계 완료

👥 총 챌린저: 10명
✅ 제출 성공: 8명
❌ 미제출: 2명
📈 성공률: 80%

✅ 제출자: @user1, @user2, @user3, @user4, @user5, @user6, @user7, @user8
⚠️ 미제출자: @user9, @user10
```

- Slack ID가 등록된 챌린저는 @멘션으로 표시됩니다
- Slack ID가 없는 챌린저는 사용자명으로 표시됩니다

#### 관리자 채널 알림 (`SLACK_MANAGE_WEBHOOK_URL`)

경고 2회 초과 시에만 전송됩니다:
```
⚠️ 퇴출 필요 | @user9님 경고 3회로 퇴출이 필요합니다.
```

### 주의사항

- 스케줄러는 **전날** 데이터를 집계합니다
- 챌린저 등록일이 집계 대상 날짜보다 이후인 경우 집계에서 제외됩니다
- 집계 결과는 `aggregation` 시트에 자동으로 저장됩니다
- 챌린저별 통계는 `challenger-stats` 시트에 저장됩니다
- 날짜 비교 시 Date 객체와 문자열을 자동으로 변환하여 처리합니다